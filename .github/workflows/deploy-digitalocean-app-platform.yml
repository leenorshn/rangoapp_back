name: Deploy to DigitalOcean App Platform

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com
  APP_NAME: rangoapp-backend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        run: |
          go test ./... -v

      - name: Build application
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags='-w -s' \
            -o server \
            ./server.go

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp server deploy/
          cp Dockerfile deploy/
          cp go.mod deploy/
          cp go.sum deploy/
          tar -czf deploy.tar.gz -C deploy .

      - name: Deploy to DigitalOcean App Platform
        uses: digitalocean/app_action@v1
        with:
          app_name: ${{ env.APP_NAME }}
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          deploy_package: deploy.tar.gz
